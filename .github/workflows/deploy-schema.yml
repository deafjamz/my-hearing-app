name: Deploy Database Schema

on:
  workflow_dispatch:
    inputs:
      migration_file:
        description: 'Migration file to run (e.g., schema_v5_core_alignment.sql)'
        required: true
        default: 'schema_v5_core_alignment.sql'
  push:
    branches:
      - main
    paths:
      - 'sql_migrations/**'

jobs:
  deploy-schema:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Supabase CLI
        run: |
          curl -sSL https://github.com/supabase/cli/releases/download/v1.123.4/supabase_1.123.4_linux_amd64.tar.gz | tar -xz
          sudo mv supabase /usr/local/bin/

      - name: Verify Supabase CLI
        run: supabase --version

      - name: Run Migration
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          # Determine which migration to run
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            MIGRATION_FILE="${{ github.event.inputs.migration_file }}"
          else
            # Get the most recent migration file from changed files
            MIGRATION_FILE=$(git diff --name-only HEAD~1 HEAD | grep "sql_migrations/" | sort | tail -1)
          fi

          echo "Running migration: $MIGRATION_FILE"

          # Execute migration using psql via Supabase
          if [ -f "sql_migrations/$MIGRATION_FILE" ]; then
            # Extract connection string from Supabase URL
            # Format: https://project-ref.supabase.co -> postgres://postgres:password@db.project-ref.supabase.co:5432/postgres

            # Note: This requires SUPABASE_DB_PASSWORD secret
            # Alternative: Use Supabase API to run migrations
            echo "‚úÖ Migration file found: sql_migrations/$MIGRATION_FILE"
            echo "‚ö†Ô∏è  Manual execution required via Supabase Dashboard"
            echo "Copy the contents of sql_migrations/$MIGRATION_FILE and run in SQL Editor"
          else
            echo "‚ùå Migration file not found: sql_migrations/$MIGRATION_FILE"
            exit 1
          fi

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üóÑÔ∏è Database schema changes detected. Please review and run migrations manually in Supabase Dashboard.'
            })
