  <!DOCTYPE html>
  <html lang="en">
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Hearing Rehabilitation Exercise</title>
      <script src="https://cdn.tailwindcss.com"></script>
      <style>
          body { font-family: Arial, sans-serif; }
          .loading-spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%;
  border-left-color: #09f; animation: spin 1s ease infinite; }
          @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      </style>
  </head>
  <body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
      <div class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-lg p-6 text-center">

          <div id="loading-state">
              <div class="loading-spinner mx-auto mb-4"></div>
              <p class="text-lg text-gray-600">Loading Exercises...</p>
              <p class="text-sm text-gray-500 mt-2" id="loading-status">Initializing...</p>
          </div>

          <div id="activity-selection-screen" class="hidden">
              <h1 class="text-2xl font-bold text-gray-800 mb-6" id="category-title">Choose a Category</h1>

              <div id="qc-mode-indicator" class="hidden mb-4 p-2 bg-red-100 border border-red-300 rounded text-center">
                  <span class="text-red-800 font-semibold">QC Mode Active</span>
                  <div class="mt-2">
                      <button id="export-qc-btn" class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 
  mr-2">Export to Forms</button>
                      <button id="disable-qc-btn" class="px-2 py-1 bg-red-600 text-white text-xs rounded 
  hover:bg-red-700">Disable</button>
                  </div>
              </div>

              <div class="space-y-4">
                  <button data-activity="words" class="activity-btn w-full py-4 px-5 text-xl font-semibold rounded-lg border-2 
  border-gray-300 hover:bg-gray-100">Word Practice</button>
                  <button data-activity="sentences" class="activity-btn w-full py-4 px-5 text-xl font-semibold rounded-lg 
  border-2 border-gray-300 hover:bg-gray-100">Sentence Recognition</button>
                  <button data-activity="keywords" class="activity-btn w-full py-4 px-5 text-xl font-semibold rounded-lg border-2
   border-gray-300 hover:bg-gray-100">Keyword Hunt</button>
              </div>
          </div>

          <div id="test-screen" class="hidden">
              <h2 class="text-xl font-bold mb-4">QC Test Mode</h2>
              <div class="space-y-4">
                  <input type="text" id="test-audio-file" class="w-full p-2 border rounded" placeholder="Audio filename" 
  value="test_audio.mp3">
                  <input type="text" id="test-text" class="w-full p-2 border rounded" placeholder="Text content" value="test 
  word">
                  <select id="test-issue-type" class="w-full p-2 border rounded">
                      <option value="unclear_pronunciation">Unclear Pronunciation</option>
                      <option value="robotic_voice">Robotic Voice</option>
                      <option value="too_fast">Too Fast</option>
                  </select>
                  <button id="test-flag-btn" class="w-full py-2 bg-red-600 text-white rounded hover:bg-red-700">Flag Test
  Issue</button>
                  <button id="test-export-btn" class="w-full py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Export Test
  Data</button>
                  <button id="back-to-main-btn" class="w-full py-2 bg-gray-600 text-white rounded hover:bg-gray-700">Back to
  Main</button>
              </div>
              <div id="test-console" class="mt-4 p-2 bg-gray-100 text-xs font-mono text-left max-h-40 overflow-y-auto"></div>
          </div>
      </div>

      <script>
          console.log('App starting...');

          var qualityIssues = JSON.parse(localStorage.getItem('qualityIssues') || '[]');
          var adminQCMode = localStorage.getItem('adminQCMode') === 'true';
          var testMode = false;

          function log(message) {
              console.log(message);
              var testConsole = document.getElementById('test-console');
              if (testConsole) {
                  testConsole.textContent += new Date().toLocaleTimeString() + ': ' + message + '\n';
                  testConsole.scrollTop = testConsole.scrollHeight;
              }
          }

          function submitToGoogleForms(qualityIssue) {
              var baseUrl =
  'https://docs.google.com/forms/d/e/1FAIpQLSdrZdSdORcvQkZm9A_ZWB3J4Q_XOY9HKKpD8GDQiyLEINqu2A/viewform';
              var params = new URLSearchParams({
                  'usp': 'pp_url',
                  'entry.2092258809': qualityIssue.audioFile,
                  'entry.2027416117': qualityIssue.text,
                  'entry.2104356900': qualityIssue.voice || 'female',
                  'entry.1322911479': qualityIssue.activityType || 'test',
                  'entry.2105236424': qualityIssue.set || 'Test Set',
                  'entry.64346061': qualityIssue.issueType,
                  'entry.1007752238': qualityIssue.severity || 'Medium',
                  'entry.215629918': qualityIssue.dateFlagged
              });
              var formUrl = baseUrl + '?' + params.toString();
              log('Opening form: ' + qualityIssue.audioFile);
              window.open(formUrl, '_blank');
              return true;
          }

          function toggleAdminQCMode() {
              adminQCMode = !adminQCMode;
              localStorage.setItem('adminQCMode', adminQCMode.toString());

              var qcIndicator = document.getElementById('qc-mode-indicator');
              if (adminQCMode) {
                  if (qcIndicator) qcIndicator.classList.remove('hidden');
                  log('QC Mode ENABLED');
              } else {
                  if (qcIndicator) qcIndicator.classList.add('hidden');
                  log('QC Mode DISABLED');
              }
          }

          function exportQualityData() {
              log('=== EXPORT START ===');
              var unsentIssues = qualityIssues.filter(function(issue) { return !issue.sentToForms; });
              log('Unsent issues: ' + unsentIssues.length);

              if (unsentIssues.length === 0) {
                  var retryAll = confirm('No new issues. Reset all and retry?');
                  if (retryAll) {
                      qualityIssues.forEach(function(issue) { delete issue.sentToForms; });
                      localStorage.setItem('qualityIssues', JSON.stringify(qualityIssues));
                      return exportQualityData();
                  }
                  return;
              }

              var message = 'Export ' + unsentIssues.length + ' issues to Google Forms?';
              var confirmForms = confirm(message);

              if (confirmForms) {
                  for (var i = 0; i < unsentIssues.length; i++) {
                      var issue = unsentIssues[i];
                      submitToGoogleForms(issue);
                      issue.sentToForms = true;
                  }
                  localStorage.setItem('qualityIssues', JSON.stringify(qualityIssues));
                  alert('Opened ' + unsentIssues.length + ' Google Forms!');
              }
              log('=== EXPORT COMPLETE ===');
          }

          function flagTestIssue() {
              var issue = {
                  audioFile: document.getElementById('test-audio-file').value,
                  text: document.getElementById('test-text').value,
                  voice: 'female',
                  activityType: 'test',
                  set: 'Test Set',
                  issueType: document.getElementById('test-issue-type').value,
                  severity: 'Medium',
                  dateFlagged: new Date().toISOString(),
                  sentToForms: false
              };

              qualityIssues.push(issue);
              localStorage.setItem('qualityIssues', JSON.stringify(qualityIssues));
              log('Test issue flagged: ' + issue.audioFile);
          }

          function showTestMode() {
              testMode = true;
              document.getElementById('activity-selection-screen').classList.add('hidden');
              document.getElementById('test-screen').classList.remove('hidden');
              log('Test mode activated');
          }

          function showMainMode() {
              testMode = false;
              document.getElementById('test-screen').classList.add('hidden');
              document.getElementById('activity-selection-screen').classList.remove('hidden');
          }

          function init() {
              log('Initializing...');

              // Simulate loading
              setTimeout(function() {
                  document.getElementById('loading-state').classList.add('hidden');
                  document.getElementById('activity-selection-screen').classList.remove('hidden');

                  if (adminQCMode) {
                      toggleAdminQCMode();
                  }

                  log('App loaded successfully!');
              }, 1000);
          }

          // Event listeners
          document.addEventListener('DOMContentLoaded', function() {
              log('DOM loaded');

              // QC buttons
              var exportBtn = document.getElementById('export-qc-btn');
              if (exportBtn) exportBtn.addEventListener('click', exportQualityData);

              var disableBtn = document.getElementById('disable-qc-btn');
              if (disableBtn) disableBtn.addEventListener('click', toggleAdminQCMode);

              // Test buttons
              var testFlagBtn = document.getElementById('test-flag-btn');
              if (testFlagBtn) testFlagBtn.addEventListener('click', flagTestIssue);

              var testExportBtn = document.getElementById('test-export-btn');
              if (testExportBtn) testExportBtn.addEventListener('click', exportQualityData);

              var backBtn = document.getElementById('back-to-main-btn');
              if (backBtn) backBtn.addEventListener('click', showMainMode);

              // Activity buttons
              var activityBtns = document.querySelectorAll('.activity-btn');
              activityBtns.forEach(function(btn) {
                  btn.addEventListener('click', function() {
                      var activity = this.getAttribute('data-activity');
                      if (activity === 'words') {
                          showTestMode();
                      } else {
                          alert('Exercise not available in test mode');
                      }
                  });
              });

              // Triple-tap for QC
              var titleTapCount = 0;
              var titleTapTimer = null;
              var categoryTitle = document.getElementById('category-title');
              if (categoryTitle) {
                  categoryTitle.addEventListener('click', function() {
                      titleTapCount++;
                      if (titleTapTimer) clearTimeout(titleTapTimer);

                      if (titleTapCount === 3) {
                          toggleAdminQCMode();
                          titleTapCount = 0;
                      } else {
                          titleTapTimer = setTimeout(function() {
                              titleTapCount = 0;
                          }, 1000);
                      }
                  });
              }

              init();
          });

          log('Script loaded');
      </script>
  </body>
  </html>
