<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hearing Rehabilitation Exercise</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .correct-answer { background-color: #28a745 !important; color: white !important; border-color: #28a745 !important; }
        .wrong-answer { background-color: #f97316 !important; color: white !important; border-color: #f97316 !important; }
        .loading-spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #09f; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Voice Toggle Styles */
        .voice-toggle-bg { background-color: #e5e7eb; }
        .voice-toggle-btn { transition: all 0.3s ease; }
        .voice-toggle-bg.female .voice-toggle-btn { transform: translateX(0%); background-color: #ec4899; }
        .voice-toggle-bg.male .voice-toggle-btn { transform: translateX(100%); background-color: #3b82f6; }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-lg p-6 md:p-8 text-center relative">
        
        <!-- Loading State -->
        <div id="loading-state">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-lg text-gray-600">Loading Exercises...</p>
        </div>

        <!-- Level Selection Screen (Initially Hidden) -->
        <div id="level-selection-screen" class="hidden">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4">Choose an Exercise</h1>
            
            <div class="mb-6">
                <p class="text-gray-600 mb-2 font-semibold">Select a Voice</p>
                <div id="voice-toggle" class="relative w-40 h-10 mx-auto rounded-full p-1 cursor-pointer voice-toggle-bg female">
                    <div class="voice-toggle-btn absolute top-1 left-1 w-1/2 h-8 rounded-full shadow-md"></div>
                    <div class="relative w-full h-full flex items-center text-white">
                        <div class="w-1/2 text-center z-10">Female</div>
                        <div class="w-1/2 text-center z-10">Male</div>
                    </div>
                </div>
            </div>

            <div id="level-buttons-container" class="grid grid-cols-1 gap-4"></div>
        </div>

        <!-- Main App Content (Initially Hidden) -->
        <div id="app-content" class="hidden">
            <header class="mb-6">
                 <button id="back-to-levels" class="absolute top-4 left-4 text-blue-600 hover:text-blue-800 font-semibold">&larr; Back to Levels</button>
                <h1 id="exercise-title" class="text-2xl md:text-3xl font-bold text-gray-800 pt-8"></h1>
            </header>

            <main>
                <div id="progress-container" class="mb-6">
                    <p class="text-lg font-medium text-gray-700">Question <span id="current-question">1</span> of <span id="total-questions">10</span></p>
                    <div class="bg-gray-200 rounded-full h-2.5 mt-2"><div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 10%"></div></div>
                </div>
                <div class="mb-8">
                    <button id="play-sound-btn" class="bg-blue-600 text-white rounded-full p-6 shadow-md hover:bg-blue-700 transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:scale-100">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
                <div id="choice-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button id="choice1-btn" class="w-full py-4 px-5 text-xl font-semibold rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition focus:outline-none disabled:bg-gray-200 disabled:cursor-not-allowed"></button>
                    <button id="choice2-btn" class="w-full py-4 px-5 text-xl font-semibold rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition focus:outline-none disabled:bg-gray-200 disabled:cursor-not-allowed"></button>
                </div>
                <div id="feedback-message" class="mt-6 text-xl font-semibold h-8"></div>
            </main>
            
            <div id="completion-screen" class="hidden text-center">
                 <h2 class="text-2xl font-bold text-gray-800 mb-4">Level Complete!</h2>
                 <p class="text-gray-600 mb-2">You scored <span id="final-score" class="font-bold"></span> out of <span id="total-score" class="font-bold"></span>.</p>
                 <button id="next-level-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition">Back to Levels</button>
            </div>
        </div>
    </div>

    <script>
        const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTOpNWzOsrU08iFaBECNU02TLXVoDQSOhM_ioLtGKcTG5dxEKxkil5l-hYWjR9HA1441VHGlke8bWLj/pub?gid=0&single=true&output=csv';
        const GITHUB_USERNAME = "deafjamz";
        const GITHUB_REPO_NAME = "hearing-rehab-audio";

        const friendlySetNames = {
            "Set 1: Voicing Contrast": "Sound Starter",
            "Set 2: Nasal Contrast": "Nasal Nuances",
            "Set 3: Vowel Height": "Vowel Power",
            "Set 4: Ling Sounds Emphasis": "Frequency Focus",
            "Set 5: Place of Articulation": "Tongue Twisters",
            "Set 6: Manner of Articulation": "Fine-Tuning",
            "Set 7: Word Initial Clusters": "Cluster Challenge",
            "Set 8: Word Final Clusters": "Finishing Sounds",
            "Set 9: Multi-Syllabic Simple": "Syllable Steps",
            "Set 10: Multi-Syllabic Complex": "Complex Combos"
        };

        const loadingState = document.getElementById('loading-state');
        const levelSelectionScreen = document.getElementById('level-selection-screen');
        const voiceToggle = document.getElementById('voice-toggle');
        const appContent = document.getElementById('app-content');
        const levelButtonsContainer = document.getElementById('level-buttons-container');
        const exerciseTitle = document.getElementById('exercise-title');
        const backToLevelsBtn = document.getElementById('back-to-levels');
        const playSoundBtn = document.getElementById('play-sound-btn');
        const choice1Btn = document.getElementById('choice1-btn');
        const choice2Btn = document.getElementById('choice2-btn');
        const feedbackMessage = document.getElementById('feedback-message');
        const currentQuestionEl = document.getElementById('current-question');
        const totalQuestionsEl = document.getElementById('total-questions');
        const progressBar = document.getElementById('progress-bar');
        const mainContent = document.querySelector('main');
        const completionScreen = document.getElementById('completion-screen');
        const finalScoreEl = document.getElementById('final-score');
        const totalScoreEl = document.getElementById('total-score');
        const nextLevelBtn = document.getElementById('next-level-btn');

        let allData = [];
        let currentLevelData = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let currentAudio = null;
        let selectedVoice = 'female';
        let correctWordForTrial = '';

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const result = [];
            const headers = lines[0].split(',').map(h => h.trim());

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                const values = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
                const obj = {};
                
                for (let j = 0; j < headers.length; j++) {
                    if (values[j]) {
                        obj[headers[j]] = values[j].replace(/"/g, '').trim();
                    }
                }
                
                if (obj.Set && obj.Word1 && obj.Word2) {
                     result.push(obj);
                }
            }
            return result;
        }

        async function fetchSheetData() {
            const csvUrl = GOOGLE_SHEET_URL;
            try {
                const response = await fetch(csvUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const csvText = await response.text();
                if (!csvText || csvText.length < 10) throw new Error('CSV data appears to be empty.');
                
                allData = parseCSV(csvText);
                if (allData.length === 0) throw new Error('No valid data rows found after parsing.');
                
                displayLevelSelection();

            } catch (error) {
                console.error('Detailed error information:', error);
                loadingState.innerHTML = `<div class="text-red-500 font-semibold"><p>Error: Could not load exercises.</p><p class="text-sm mt-2">Details: ${error.message}</p></div>`;
            }
        }

        function displayLevelSelection() {
            loadingState.classList.add('hidden');
            appContent.classList.add('hidden');
            completionScreen.classList.add('hidden');
            levelSelectionScreen.classList.remove('hidden');
            levelButtonsContainer.innerHTML = '';

            const sets = [...new Set(allData.map(item => item.Set))];
            
            sets.forEach(setName => {
                const button = document.createElement('button');
                button.className = 'w-full py-4 px-5 text-xl font-semibold rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition focus:outline-none';
                button.textContent = friendlySetNames[setName] || setName;
                button.onclick = () => startLevel(setName);
                levelButtonsContainer.appendChild(button);
            });
        }

        function startLevel(setName) {
            currentLevelData = allData.filter(item => item.Set === setName);
            shuffleArray(currentLevelData);
            
            currentQuestionIndex = 0;
            score = 0;

            exerciseTitle.textContent = friendlySetNames[setName] || setName;
            levelSelectionScreen.classList.add('hidden');
            appContent.classList.remove('hidden');
            mainContent.classList.remove('hidden');
            completionScreen.classList.add('hidden');

            loadQuestion();
        }

        function loadQuestion() {
            if (currentQuestionIndex >= currentLevelData.length) {
                showCompletionScreen();
                return;
            }

            feedbackMessage.className = 'mt-6 text-xl font-semibold h-8';
            choice1Btn.className = 'w-full py-4 px-5 text-xl font-semibold rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition focus:outline-none disabled:bg-gray-200 disabled:cursor-not-allowed';
            choice2Btn.className = 'w-full py-4 px-5 text-xl font-semibold rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition focus:outline-none disabled:bg-gray-200 disabled:cursor-not-allowed';
            
            choice1Btn.disabled = true;
            choice2Btn.disabled = true;
            playSoundBtn.disabled = false;

            const currentPair = currentLevelData[currentQuestionIndex];
            
            const choiceOptions = [currentPair.Word1, currentPair.Word2];
            shuffleArray(choiceOptions);

            choice1Btn.textContent = choiceOptions[0].replaceAll('...', '');
            choice2Btn.textContent = choiceOptions[1].replaceAll('...', '');
            
            correctWordForTrial = Math.random() > 0.5 ? currentPair.Word1 : currentPair.Word2;
            
            const audioFolder = `${selectedVoice}_audio`;
            const audioFileName = encodeURIComponent(correctWordForTrial) + '.mp3';
            
            // --- DEFINITIVE FIX: Use the raw GitHub content URL ---
            const audioUrl = `https://raw.githubusercontent.com/${GITHUB_USERNAME}/${GITHUB_REPO_NAME}/main/${audioFolder}/${audioFileName}`;

            console.log("Attempting to load audio from:", audioUrl);

            currentAudio = new Audio(audioUrl);
            currentAudio.onerror = (e) => {
                console.error("Audio loading error:", e);
                feedbackMessage.textContent = `Error loading audio. Check console for URL.`;
                playSoundBtn.disabled = true;
            };
            
            totalQuestionsEl.textContent = currentLevelData.length;
            currentQuestionEl.textContent = currentQuestionIndex + 1;
            progressBar.style.width = `${((currentQuestionIndex + 1) / currentLevelData.length) * 100}%`;
        }

        function handleAnswer(selectedButton) {
            if (!currentAudio) return;
            
            playSoundBtn.disabled = true;
            choice1Btn.disabled = true;
            choice2Btn.disabled = true;

            const selectedWord = selectedButton.textContent;
            const cleanedCorrectWord = correctWordForTrial.replaceAll('...', '');

            if (selectedWord === cleanedCorrectWord) {
                score++;
                feedbackMessage.textContent = 'Correct!';
                feedbackMessage.classList.add('text-green-500');
                selectedButton.classList.add('correct-answer');
            } else {
                feedbackMessage.textContent = 'Try Again';
                feedbackMessage.classList.add('text-orange-500');
                selectedButton.classList.add('wrong-answer');
            }
            
            setTimeout(() => {
                currentQuestionIndex++;
                loadQuestion();
            }, 1500);
        }
        
        function showCompletionScreen() {
            mainContent.classList.add('hidden');
            completionScreen.classList.remove('hidden');
            finalScoreEl.textContent = score;
            totalScoreEl.textContent = currentLevelData.length;
        }
        
        // --- Event Listeners ---
        voiceToggle.addEventListener('click', () => {
            if (selectedVoice === 'female') {
                selectedVoice = 'male';
                voiceToggle.classList.remove('female');
                voiceToggle.classList.add('male');
            } else {
                selectedVoice = 'female';
                voiceToggle.classList.remove('male');
                voiceToggle.classList.add('female');
            }
        });

        backToLevelsBtn.addEventListener('click', displayLevelSelection);
        nextLevelBtn.addEventListener('click', displayLevelSelection);
        
        playSoundBtn.addEventListener('click', () => {
            if (currentAudio) {
                currentAudio.play().catch(e => console.error("Error playing audio:", e));
                choice1Btn.disabled = false;
                choice2Btn.disabled = false;
            }
        });
        
        choice1Btn.addEventListener('click', () => handleAnswer(choice1Btn));
        choice2Btn.addEventListener('click', () => handleAnswer(choice2Btn));
        
        // --- Initial Load ---
        fetchSheetData();
    </script>
</body>
</html>
