<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hearing Rehabilitation Exercise</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        .correct-answer { background-color: #28a745 !important; color: white !important; }
        .wrong-answer { background-color: #f97316 !important; color: white !important; }
        .loading-spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #09f; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .voice-toggle-bg { background-color: #e5e7eb; }
        .voice-toggle-btn { transition: all 0.3s ease; }
        .voice-toggle-bg.female .voice-toggle-btn { transform: translateX(0%); background-color: #ec4899; }
        .voice-toggle-bg.male .voice-toggle-btn { transform: translateX(100%); background-color: #3b82f6; }
        .audio-ready { border-color: #10b981 !important; }
        .audio-error { border-color: #ef4444 !important; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-lg p-6 md:p-8 text-center relative">
        
        <!-- Loading State -->
        <div id="loading-state">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-lg text-gray-600">Loading Exercises...</p>
            <div id="loading-progress" class="mt-4">
                <div class="bg-gray-200 rounded-full h-2">
                    <div id="loading-progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p class="text-sm text-gray-500 mt-2" id="loading-status">Initializing...</p>
            </div>
        </div>

        <!-- Activity Selection -->
        <div id="activity-selection-screen" class="hidden fade-in">
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-6" id="category-title">Choose a Category</h1>
            
            <!-- QC Mode Indicator -->
            <div id="qc-mode-indicator" class="hidden mb-4 p-2 bg-red-100 border border-red-300 rounded text-center">
                <span class="text-red-800 font-semibold">ðŸ”§ Admin QC Mode Active</span>
                <div class="mt-2 flex gap-2 justify-center">
                    <button id="export-qc-btn" class="px-2 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700">Export to Forms</button>
                    <button id="disable-qc-btn" class="px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700">Disable</button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 gap-4">
                <button data-activity="words" class="activity-btn w-full py-4 px-5 text-xl font-semibold rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition">
                    <div class="flex items-center justify-between">
                        <span>Word Practice</span>
                        <span id="words-progress" class="text-sm bg-gray-100 px-2 py-1 rounded">0/10</span>
                    </div>
                </button>
                <button data-activity="sentences" class="activity-btn w-full py-4 px-5 text-xl font-semibold rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition">
                    <div class="flex items-center justify-between">
                        <span>Sentence Recognition</span>
                        <span id="sentences-progress" class="text-sm bg-gray-100 px-2 py-1 rounded">0/10</span>
                    </div>
                </button>
                <button data-activity="keywords" class="activity-btn w-full py-4 px-5 text-xl font-semibold rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition">
                    <div class="flex items-center justify-between">
                        <span>Keyword Hunt</span>
                        <span id="keywords-progress" class="text-sm bg-gray-100 px-2 py-1 rounded">0/30</span>
                    </div>
                </button>
                <button data-activity="stories" class="activity-btn w-full py-4 px-5 text-xl font-semibold rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition">
                    <div class="flex items-center justify-between">
                        <span>Story Practice</span>
                        <span id="stories-progress" class="text-sm bg-gray-100 px-2 py-1 rounded">0/10</span>
                    </div>
                </button>
            </div>
        </div>

        <!-- Level Selection -->
        <div id="level-selection-screen" class="hidden fade-in">
            <div class="w-full mb-4 text-left">
                <button id="back-to-activities" class="text-blue-600 hover:text-blue-800 font-semibold">&larr; Back to Categories</button>
            </div>
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4">Choose an Exercise</h1>
            <div class="mb-6">
                <p class="text-gray-600 mb-2 font-semibold">Select a Voice</p>
                <div id="voice-toggle" class="relative w-40 h-10 mx-auto rounded-full p-1 cursor-pointer voice-toggle-bg female">
                    <div class="voice-toggle-btn absolute top-1 left-1 w-1/2 h-8 rounded-full shadow-md"></div>
                    <div class="relative w-full h-full flex items-center text-white">
                        <div class="w-1/2 text-center z-10">Female</div>
                        <div class="w-1/2 text-center z-10">Male</div>
                    </div>
                </div>
            </div>
            <div id="level-buttons-container" class="grid grid-cols-1 gap-4"></div>
        </div>

        <!-- Exercise Interface -->
        <div id="app-content" class="hidden fade-in">
            <header class="mb-6">
                <div class="flex justify-between items-center mb-4">
                    <button id="back-to-levels" class="text-blue-600 hover:text-blue-800 font-semibold">&larr; Back to Exercises</button>
                    <div class="text-right">
                        <div class="text-sm text-gray-600">Question <span id="current-question">1</span> of <span id="total-questions">10</span></div>
                        <div class="text-sm text-gray-600">Score: <span id="current-score">0</span></div>
                    </div>
                </div>
                <h1 id="exercise-title" class="text-xl md:text-2xl font-bold text-gray-800"></h1>
                <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                    <div id="progress-bar" class="bg-blue-600 h-2 rounded-full transition-all duration-500"></div>
                </div>
            </header>

            <main>
                <!-- Audio Player -->
                <div class="bg-gray-50 p-6 rounded-lg mb-6">
                    <button id="play-sound-btn" class="bg-blue-600 text-white rounded-full p-6 shadow-md hover:bg-blue-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>

                <!-- Choice Buttons -->
                <div id="choice-container" class="grid grid-cols-1 gap-4">
                    <button id="choice1-btn" class="w-full py-3 px-4 text-lg font-semibold rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition disabled:bg-gray-200 disabled:cursor-not-allowed"></button>
                    <button id="choice2-btn" class="w-full py-3 px-4 text-lg font-semibold rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition disabled:bg-gray-200 disabled:cursor-not-allowed"></button>
                </div>

                <!-- QC Controls -->
                <div id="qc-controls" class="hidden mt-4 p-3 bg-red-50 border border-red-200 rounded">
                    <button id="flag-audio-btn" class="w-full py-2 px-3 bg-red-600 text-white text-sm rounded hover:bg-red-700 mb-2">Flag Audio Quality</button>
                    <select id="issue-type" class="w-full text-xs p-1 border rounded">
                        <option value="unclear_pronunciation">Unclear Pronunciation</option>
                        <option value="robotic_voice">Robotic Voice</option>
                        <option value="too_fast">Too Fast</option>
                        <option value="too_slow">Too Slow</option>
                        <option value="background_noise">Background Noise</option>
                    </select>
                </div>

                <!-- Keyword Question Container -->
                <div id="keyword-question-container" class="hidden mt-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-2">What keyword did you hear?</h3>
                    <div id="keyword-choices" class="grid grid-cols-2 gap-2"></div>
                </div>

                <!-- Story Interface -->
                <div id="story-interface" class="hidden mt-6">
                    <!-- Caption Level Selector -->
                    <div class="mb-4">
                        <p class="text-sm font-semibold text-gray-700 mb-2">Caption Level</p>
                        <div class="flex gap-2 justify-center">
                            <button data-caption-level="25" class="caption-btn px-3 py-1 text-xs rounded-full border bg-blue-600 text-white">25%</button>
                            <button data-caption-level="50" class="caption-btn px-3 py-1 text-xs rounded-full border border-gray-300">50%</button>
                            <button data-caption-level="75" class="caption-btn px-3 py-1 text-xs rounded-full border border-gray-300">75%</button>
                            <button data-caption-level="100" class="caption-btn px-3 py-1 text-xs rounded-full border border-gray-300">100%</button>
                        </div>
                    </div>

                    <!-- Story Text Display -->
                    <div id="story-text" class="bg-gray-50 p-4 rounded-lg mb-4 text-left">
                        <p id="story-caption" class="text-gray-800 leading-relaxed">Listen to the story, then answer the question below.</p>
                    </div>

                    <!-- Story Question -->
                    <div id="story-question" class="mb-4">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3" id="story-question-text">What happened in the story?</h3>
                        <div id="story-choices" class="space-y-2"></div>
                    </div>
                </div>

                <!-- Feedback -->
                <div id="feedback-message" class="mt-6 text-xl font-semibold h-8"></div>
            </main>
            
            <!-- Completion Screen -->
            <div id="completion-screen" class="hidden text-center fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Level Complete!</h2>
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                    <p class="text-gray-600 mb-2">You scored <span id="final-score" class="font-bold text-green-600"></span> out of <span id="total-score" class="font-bold"></span>.</p>
                    <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                        <div id="final-progress-bar" class="bg-green-600 h-2 rounded-full transition-all duration-500"></div>
                    </div>
                </div>
                <div class="flex gap-3 justify-center">
                    <button id="retry-level-btn" class="bg-gray-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-700 transition">Retry Level</button>
                    <button id="next-level-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition">Try Another Exercise</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const GITHUB_USERNAME = "deafjamz";
        const GITHUB_REPO_NAME = "hearing-rehab-audio";
        const AUDIO_CACHE_SIZE = 50;

        const friendlySetNames = {
            "Set 1: Voicing Contrast": "Sound Starter",
            "Set 2: Nasal Contrast": "Nasal Nuances",
            "Set 3: Vowel Height": "Vowel Power",
            "Set 4: Ling Sounds Emphasis": "Frequency Focus",
            "Set 5: Place of Articulation": "Tongue Twisters",
            "Set 6: Manner of Articulation": "Fine-Tuning",
            "Set 7: Word Initial Clusters": "Cluster Challenge",
            "Set 8: Word Final Clusters": "Finishing Sounds",
            "Set 9: Multi-Syllabic Simple": "Syllable Steps",
            "Set 10: Multi-Syllabic Complex": "Complex Combos"
        };
        
        let allData = { words: [], sentences: [], keywords: [], stories: [] };

        // User's 10 custom stories - optimized for ElevenLabs generation
        const sampleStories = [
            {
                id: "story1",
                title: "The Timid Teacup",
                fullText: "Barnaby was a teacup who was afraid of tea. He saw the big, steaming pot and shivered, his porcelain chattering. One day, a little girl with warm hands chose him. 'You're my favorite,' she whispered. She filled him not with tea, but with cool milk and a single strawberry. Barnaby decided he wasn't afraid anymore.",
                captions: {
                    25: "Barnaby... teacup... afraid... tea... girl... milk... strawberry...",
                    50: "Barnaby teacup afraid tea girl warm hands favorite milk strawberry",
                    75: "Barnaby was a [BLANK] who was afraid of tea. One day, a little [BLANK] with warm hands chose him. She filled him with cool [BLANK] and a strawberry.",
                    100: "Barnaby was a teacup who was afraid of tea. He saw the big, steaming pot and shivered, his porcelain chattering. One day, a little girl with warm hands chose him. 'You're my favorite,' she whispered. She filled him not with tea, but with cool milk and a single strawberry. Barnaby decided he wasn't afraid anymore."
                },
                question: "What did the little girl fill Barnaby with instead of tea?",
                choices: [
                    "Cool milk and a strawberry",
                    "Hot chocolate",
                    "Orange juice",
                    "Water and sugar"
                ],
                correctAnswer: 0,
                difficulty: "easy",
                audioFile: "story_timid_teacup.mp3"
            },
            {
                id: "story2", 
                title: "The Compass Who Lost His North",
                fullText: "Miles was a brass compass whose needle always pointed to his favorite armchair. Not North. This was a problem, as he belonged to a famous explorer named Penelope. 'Useless!' she'd mutter, stuffing him in a pocket filled with lint. One day, Penelope got terribly lost in a foggy forest. She pulled Miles out in desperation. He couldn't find North, but he could find the way back to his armchair. He spun confidently, pointing through the fog. Penelope followed, and soon they were home, safe and warm. Miles never found North, but he had found his purpose.",
                captions: {
                    25: "Miles... compass... armchair... North... Penelope... lost... forest... home...",
                    50: "Miles compass needle armchair North Penelope explorer lost forest home purpose",
                    75: "Miles was a brass [BLANK] whose needle pointed to his armchair, not North. Penelope got lost in a foggy [BLANK]. Miles pointed the way back [BLANK].",
                    100: "Miles was a brass compass whose needle always pointed to his favorite armchair. Not North. This was a problem, as he belonged to a famous explorer named Penelope. 'Useless!' she'd mutter, stuffing him in a pocket filled with lint. One day, Penelope got terribly lost in a foggy forest. She pulled Miles out in desperation. He couldn't find North, but he could find the way back to his armchair. He spun confidently, pointing through the fog. Penelope followed, and soon they were home, safe and warm. Miles never found North, but he had found his purpose."
                },
                question: "How did Miles help Penelope when she was lost?",
                choices: [
                    "He pointed the way back to his armchair",
                    "He found true North",
                    "He called for help",
                    "He created a map"
                ],
                correctAnswer: 0,
                difficulty: "medium",
                audioFile: "story_compass_north.mp3"
            },
            {
                id: "story3",
                title: "The Left Sock",
                fullText: "In the world under the dryer, there lived a civilization of lost socks. Their leader was a wise, argyle sock named Argus. He had seen many things, mostly the inside of a washing machine. One day, a young, bright pink sock with stripes fell from the sky. 'Where am I?' she cried. 'You are in the Land of the Lost,' Argus said calmly. 'But I'm not lost! I'm a left sock! My right sock is waiting for me!' The other socks chuckled. No one ever found their match. But the pink sock was determined. She spent weeks learning the terrainâ€”the mountains of forgotten sweaters, the canyons of lint. She befriended a lonely button and a wise old dust bunny. Together, they navigated the treacherous landscape back to the laundry room door. Just as she was about to give up hope, the dryer door opened, and a matching pink sock tumbled out. It was a joyful reunion, and a legend was born in the Land of the Lost.",
                captions: {
                    25: "socks... dryer... Argus... pink sock... lost... match... reunion...",
                    50: "lost socks dryer Argus pink sock Land Lost match reunion legend",
                    75: "In the world under the dryer lived lost [BLANK]. A pink sock fell from the sky. She found her [BLANK] sock and created a legend.",
                    100: "In the world under the dryer, there lived a civilization of lost socks. Their leader was a wise, argyle sock named Argus. He had seen many things, mostly the inside of a washing machine. One day, a young, bright pink sock with stripes fell from the sky. 'Where am I?' she cried. 'You are in the Land of the Lost,' Argus said calmly. 'But I'm not lost! I'm a left sock! My right sock is waiting for me!' The other socks chuckled. No one ever found their match. But the pink sock was determined. She spent weeks learning the terrainâ€”the mountains of forgotten sweaters, the canyons of lint. She befriended a lonely button and a wise old dust bunny. Together, they navigated the treacherous landscape back to the laundry room door. Just as she was about to give up hope, the dryer door opened, and a matching pink sock tumbled out. It was a joyful reunion, and a legend was born in the Land of the Lost."
                },
                question: "What made the pink sock different from the other lost socks?",
                choices: [
                    "She believed she could find her match",
                    "She was the newest arrival",
                    "She was the brightest color",
                    "She was the smallest sock"
                ],
                correctAnswer: 0,
                difficulty: "medium",
                audioFile: "story_left_sock.mp3"
            },
            {
                id: "story4",
                title: "The Grumpy Cloud",
                fullText: "Nimbus was a cloud who hated parades. Everyone else loved themâ€”the fluffy white clouds would form shapes of bunnies and dragons. But Nimbus preferred to be a respectable, grumpy gray. One day, the Sun, who was the grand marshal of the annual Sky Parade, assigned Nimbus a very important job. 'You,' the Sun declared, 'will provide the dramatic tension!' Nimbus was confused. During the parade, as a procession of rainbow-colored clouds drifted by, the Sun gave him a nod. Nimbus did what he did best: he grumbled. A low, rolling thunder echoed from his center. The other clouds gasped. The little star-shaped clouds twinkled nervously. The audience on the ground looked up with anticipation. Then, as the final, majestic sunbeam float passed, Nimbus, on cue, produced a single, perfect, shimmering raindrop that landed right on the parade judge's nose. The judge, a cranky old moonbeam, laughed so hard that he declared it the best parade ever. Nimbus discovered that even a grumpy cloud has an important part to play, and he secretly looked forward to next year's parade.",
                captions: {
                    25: "Nimbus... cloud... parade... grumpy... Sun... thunder... raindrop... judge...",
                    50: "Nimbus grumpy cloud hated parades Sun dramatic tension thunder raindrop judge best parade",
                    75: "Nimbus was a grumpy [BLANK] who hated parades. The Sun gave him the job of providing dramatic [BLANK]. His thunder and raindrop made it the best [BLANK] ever.",
                    100: "Nimbus was a cloud who hated parades. Everyone else loved themâ€”the fluffy white clouds would form shapes of bunnies and dragons. But Nimbus preferred to be a respectable, grumpy gray. One day, the Sun, who was the grand marshal of the annual Sky Parade, assigned Nimbus a very important job. 'You,' the Sun declared, 'will provide the dramatic tension!' Nimbus was confused. During the parade, as a procession of rainbow-colored clouds drifted by, the Sun gave him a nod. Nimbus did what he did best: he grumbled. A low, rolling thunder echoed from his center. The other clouds gasped. The little star-shaped clouds twinkled nervously. The audience on the ground looked up with anticipation. Then, as the final, majestic sunbeam float passed, Nimbus, on cue, produced a single, perfect, shimmering raindrop that landed right on the parade judge's nose. The judge, a cranky old moonbeam, laughed so hard that he declared it the best parade ever. Nimbus discovered that even a grumpy cloud has an important part to play, and he secretly looked forward to next year's parade."
                },
                question: "What special job did the Sun give Nimbus in the parade?",
                choices: [
                    "Provide dramatic tension",
                    "Form animal shapes",
                    "Lead the procession",
                    "Make rainbow colors"
                ],
                correctAnswer: 0,
                difficulty: "medium",
                audioFile: "story_grumpy_cloud.mp3"
            },
            {
                id: "story5",
                title: "The Streetlight That Dreamed of Stars",
                fullText: "Edison was a streetlight on a quiet, sleepy corner. His job was simple: from dusk until dawn, he cast a perfect circle of orange light onto the pavement. It was a good, steady job, but Edison dreamed of more. He spent his nights staring up at the vast, glittering blanket of the sky. He didn't want to just illuminate a small patch of sidewalk; he wanted to be a star. He tried to shine brighter, hoping a passing comet might notice him. He tried to flicker, imagining he was twinkling. The other streetlights just buzzed at him to be sensible. 'We are lights of the street, not lights of the sky,' they'd say. One cold, winter night, a little girl was walking home, clutching a drawing. A gust of wind snatched it from her hands and sent it fluttering into the air. Crying, she lost sight of it in the darkness. Edison, seeing her distress, put all his effort into one magnificent surge of light, shining far brighter than ever before. For a single, brilliant moment, his orange glow illuminated the lost drawing, pinned against a tree branch. The little girl found her masterpiece and looked up at Edison with a grateful smile. 'Thank you, my star,' she whispered. Edison had never been happier. He realized you didn't have to be in the sky to be someone's star.",
                captions: {
                    25: "Edison... streetlight... star... dreams... girl... drawing... wind... light...",
                    50: "Edison streetlight dreamed stars girl lost drawing wind bright light thank you my star",
                    75: "Edison was a streetlight who dreamed of being a [BLANK]. A girl lost her drawing in the wind. Edison's bright [BLANK] helped her find it.",
                    100: "Edison was a streetlight on a quiet, sleepy corner. His job was simple: from dusk until dawn, he cast a perfect circle of orange light onto the pavement. It was a good, steady job, but Edison dreamed of more. He spent his nights staring up at the vast, glittering blanket of the sky. He didn't want to just illuminate a small patch of sidewalk; he wanted to be a star. He tried to shine brighter, hoping a passing comet might notice him. He tried to flicker, imagining he was twinkling. The other streetlights just buzzed at him to be sensible. 'We are lights of the street, not lights of the sky,' they'd say. One cold, winter night, a little girl was walking home, clutching a drawing. A gust of wind snatched it from her hands and sent it fluttering into the air. Crying, she lost sight of it in the darkness. Edison, seeing her distress, put all his effort into one magnificent surge of light, shining far brighter than ever before. For a single, brilliant moment, his orange glow illuminated the lost drawing, pinned against a tree branch. The little girl found her masterpiece and looked up at Edison with a grateful smile. 'Thank you, my star,' she whispered. Edison had never been happier. He realized you didn't have to be in the sky to be someone's star."
                },
                question: "How did Edison help the little girl?",
                choices: [
                    "He shined brightly to illuminate her lost drawing",
                    "He called out to get her attention",
                    "He moved his light to follow her",
                    "He flickered to signal where it was"
                ],
                correctAnswer: 0,
                difficulty: "hard",
                audioFile: "story_streetlight_stars.mp3"
            },
            {
                id: "story6",
                title: "The Eraser Who Couldn't Forget",
                fullText: "Smudge was an eraser, but he had a secret flaw: he remembered every mistake he had ever fixed. He remembered the backwards 'S' from little Timmy's first story, the misspelled 'banana' from a grocery list, and the extra leg on a drawing of a horse. These memories weighed him down, making him gray and gritty. The other art supplies in the pencil case didn't understand. 'Your job is to forget!' the sharpener would grind at him. The pencil agreed, saying, 'A clean slate is a happy slate!' But Smudge couldn't help it. He felt like a fraud, a monument to every error ever made. One afternoon, the artist they belonged to was working on her most important painting yetâ€”a portrait of her grandfather. Her hand slipped, leaving a long, dark streak across his cheek. She gasped in despair. 'It's ruined!' she cried, ready to tear the canvas. But Smudge, seeing the familiar shape of the error, knew exactly what to do. 'Wait!' he squeaked, and he rolled onto the canvas. Because he remembered every smudge and slip, he knew the precise pressure, the exact angle, and the perfect motion to lift the graphite without harming the paper underneath. He moved with a grace no other eraser possessed. When he was done, the mistake was gone, completely. The artist stared in wonder. 'You saved it!' she said. Smudge finally understood. His memories weren't a flaw; they were his experience. They made him the best eraser in the world.",
                captions: {
                    25: "Smudge... eraser... memories... mistakes... artist... painting... grandfather... saved...",
                    50: "Smudge eraser remembered mistakes artist painting grandfather streak canvas saved experience best eraser world",
                    75: "Smudge was an eraser who remembered every [BLANK] he fixed. When the artist made a streak on her grandfather's [BLANK], his memories helped him save it perfectly.",
                    100: "Smudge was an eraser, but he had a secret flaw: he remembered every mistake he had ever fixed. He remembered the backwards 'S' from little Timmy's first story, the misspelled 'banana' from a grocery list, and the extra leg on a drawing of a horse. These memories weighed him down, making him gray and gritty. The other art supplies in the pencil case didn't understand. 'Your job is to forget!' the sharpener would grind at him. The pencil agreed, saying, 'A clean slate is a happy slate!' But Smudge couldn't help it. He felt like a fraud, a monument to every error ever made. One afternoon, the artist they belonged to was working on her most important painting yetâ€”a portrait of her grandfather. Her hand slipped, leaving a long, dark streak across his cheek. She gasped in despair. 'It's ruined!' she cried, ready to tear the canvas. But Smudge, seeing the familiar shape of the error, knew exactly what to do. 'Wait!' he squeaked, and he rolled onto the canvas. Because he remembered every smudge and slip, he knew the precise pressure, the exact angle, and the perfect motion to lift the graphite without harming the paper underneath. He moved with a grace no other eraser possessed. When he was done, the mistake was gone, completely. The artist stared in wonder. 'You saved it!' she said. Smudge finally understood. His memories weren't a flaw; they were his experience. They made him the best eraser in the world."
                },
                question: "What made Smudge different from other erasers?",
                choices: [
                    "He remembered every mistake he had fixed",
                    "He was the biggest eraser",
                    "He could talk to artists",
                    "He was made of special material"
                ],
                correctAnswer: 0,
                difficulty: "hard",
                audioFile: "story_eraser_forget.mp3"
            },
            {
                id: "story7",
                title: "The Last Autumn Leaf",
                fullText: "Leo was the last leaf on the great oak tree. All his brothers and sisters had long since let go, dancing down to the ground in a brilliant cascade of red and gold. But Leo held on. He wasn't afraid of falling; he was afraid of what came next. The wind whispered to him, 'It's time, little one. It's the way of things.' The branches creaked their agreement. But Leo gripped the twig with all his might. He watched the world below transform. Children built forts in the piles of his fallen siblings. A squirrel used one of his cousins as a blanket. The world moved on without him. He grew tired and brittle. One morning, a tiny snowflake, the very first of the season, landed gently on his surface. It didn't push him or scold him. It just sat there, cool and quiet. 'You're new,' Leo rustled. 'I am,' the snowflake whispered back. 'And soon, there will be millions of me. We will cover the world in a soft, white blanket so it can rest. But we can't start until the last leaf falls.' Leo looked down at the sleeping world and then at the patient snowflake. He finally understood. It wasn't about the end of his own story, but the beginning of another's. With a final, peaceful sigh, he let go. He didn't fall. He floated, spiraling gracefully down, the first snowflake's trusted companion on the journey to the quiet, waiting earth.",
                captions: {
                    25: "Leo... last leaf... oak tree... snowflake... fall... winter... beginning...",
                    50: "Leo last leaf oak tree afraid falling snowflake winter blanket let go beginning another story",
                    75: "Leo was the last [BLANK] on the oak tree. A snowflake told him winter couldn't start until the last leaf [BLANK]. Leo understood and let go.",
                    100: "Leo was the last leaf on the great oak tree. All his brothers and sisters had long since let go, dancing down to the ground in a brilliant cascade of red and gold. But Leo held on. He wasn't afraid of falling; he was afraid of what came next. The wind whispered to him, 'It's time, little one. It's the way of things.' The branches creaked their agreement. But Leo gripped the twig with all his might. He watched the world below transform. Children built forts in the piles of his fallen siblings. A squirrel used one of his cousins as a blanket. The world moved on without him. He grew tired and brittle. One morning, a tiny snowflake, the very first of the season, landed gently on his surface. It didn't push him or scold him. It just sat there, cool and quiet. 'You're new,' Leo rustled. 'I am,' the snowflake whispered back. 'And soon, there will be millions of me. We will cover the world in a soft, white blanket so it can rest. But we can't start until the last leaf falls.' Leo looked down at the sleeping world and then at the patient snowflake. He finally understood. It wasn't about the end of his own story, but the beginning of another's. With a final, peaceful sigh, he let go. He didn't fall. He floated, spiraling gracefully down, the first snowflake's trusted companion on the journey to the quiet, waiting earth."
                },
                question: "Why did Leo finally decide to let go of the tree?",
                choices: [
                    "He realized his falling would allow winter to begin",
                    "The wind became too strong",
                    "He was tired of holding on",
                    "Other leaves told him to fall"
                ],
                correctAnswer: 0,
                difficulty: "hard",
                audioFile: "story_autumn_leaf.mp3"
            },
            {
                id: "story8",
                title: "The Fork Who Wished He Was a Spoon",
                fullText: "Forky was, for all intents and purposes, a perfectly good fork. He had four sharp, gleaming tines. He was excellent at stabbing peas, twirling spaghetti, and securing pieces of chicken. But in his heart, he yearned to be a spoon. He watched with envy as the spoons got to scoop up all the best things: ice cream, soup, pudding, and the sugary milk at the bottom of a cereal bowl. His life felt pointy and incomplete. One evening, the family was having soup for dinner. Forky was left in the drawer, listening to the happy clinking of the spoons against the bowls. But then he heard a small voice cry out. The youngest child had dropped her spoon on the floor. 'I can't eat my soup!' she wailed. Her father sighed. 'All the other spoons are dirty, sweetheart. We'll have to wash one.' But the little girl was hungry now. Forky knew this was his moment. He wiggled his way to the front of the drawer. The father, seeing him, had an idea. He took Forky and also grabbed a piece of bread from a basket on the table. He showed his daughter how to spear a piece of bread with Forky's tines and then use the bread to soak up the delicious soup. It was a revelation! The little girl giggled as she ate her entire meal using the fork-and-bread contraption. Forky had never felt so useful. He realized he didn't need to be a spoon to scoop up soup. He just needed to be a clever fork with a good partner.",
                captions: {
                    25: "Forky... fork... spoon... soup... bread... tines... soak... useful...",
                    50: "Forky fork wished spoon soup bread tines soak clever partner useful revelation",
                    75: "Forky was a fork who wished he was a [BLANK]. When a girl needed to eat soup, he learned to work with [BLANK] to soak it up.",
                    100: "Forky was, for all intents and purposes, a perfectly good fork. He had four sharp, gleaming tines. He was excellent at stabbing peas, twirling spaghetti, and securing pieces of chicken. But in his heart, he yearned to be a spoon. He watched with envy as the spoons got to scoop up all the best things: ice cream, soup, pudding, and the sugary milk at the bottom of a cereal bowl. His life felt pointy and incomplete. One evening, the family was having soup for dinner. Forky was left in the drawer, listening to the happy clinking of the spoons against the bowls. But then he heard a small voice cry out. The youngest child had dropped her spoon on the floor. 'I can't eat my soup!' she wailed. Her father sighed. 'All the other spoons are dirty, sweetheart. We'll have to wash one.' But the little girl was hungry now. Forky knew this was his moment. He wiggled his way to the front of the drawer. The father, seeing him, had an idea. He took Forky and also grabbed a piece of bread from a basket on the table. He showed his daughter how to spear a piece of bread with Forky's tines and then use the bread to soak up the delicious soup. It was a revelation! The little girl giggled as she ate her entire meal using the fork-and-bread contraption. Forky had never felt so useful. He realized he didn't need to be a spoon to scoop up soup. He just needed to be a clever fork with a good partner."
                },
                question: "How did Forky help the little girl eat her soup?",
                choices: [
                    "He speared bread to soak up the soup",
                    "He turned into a spoon",
                    "He called other utensils to help",
                    "He poked holes in the bowl"
                ],
                correctAnswer: 0,
                difficulty: "medium",
                audioFile: "story_fork_spoon.mp3"
            },
            {
                id: "story9",
                title: "The Clock That Ran Backwards",
                fullText: "In a dusty antique shop sat a small, mahogany clock named Horatio. Unlike the other clocks, who proudly marched forward, ticking off the seconds, Horatio's hands swept counter-clockwise. He didn't tick; he tocked. The other antiques mocked him. 'He's unraveling time!' cackled a grandfather clock. 'An utter disgrace to horology!' hissed a cuckoo clock. Horatio was lonely, as no one wanted a clock that couldn't tell them what time it was, but only what time it had been. The shopkeeper, a kind old man named Mr. Gable, would just polish him gently and say, 'Your time will come, my friend.' One day, a woman came into the shop, her eyes red with tears. She had lost a precious locket her grandmother had given her, a locket she remembered holding just that morning. She was distraught, trying to retrace her steps, but her memory was a jumble of stress. Mr. Gable had a thought. He brought Horatio to the woman and set him on the counter. 'Watch this,' he said. The little clock's hands began to move backwards, tocking softly. 'Ah,' said the woman, her eyes following the hands. 'An hour ago... I was paying for my newspaper.' The hands moved further. 'Three hours ago... I was at the cafe.' As the clock's hands swept backwards, so did her memory, becoming clearer and more organized with each tock. 'Wait!' she gasped. 'I remember now! I took it off to wash my hands at the cafe!' She rushed out of the shop, only to return an hour later, the silver locket gleaming in her hand. She bought Horatio on the spot. He didn't just tell time; he found lost time.",
                captions: {
                    25: "Horatio... clock... backwards... locket... memory... cafe... lost time...",
                    50: "Horatio clock backwards tocked locket woman memory cafe lost time found",
                    75: "Horatio was a clock that ran [BLANK]. A woman lost her grandmother's locket. Horatio's backwards movement helped her [BLANK] where she left it.",
                    100: "In a dusty antique shop sat a small, mahogany clock named Horatio. Unlike the other clocks, who proudly marched forward, ticking off the seconds, Horatio's hands swept counter-clockwise. He didn't tick; he tocked. The other antiques mocked him. 'He's unraveling time!' cackled a grandfather clock. 'An utter disgrace to horology!' hissed a cuckoo clock. Horatio was lonely, as no one wanted a clock that couldn't tell them what time it was, but only what time it had been. The shopkeeper, a kind old man named Mr. Gable, would just polish him gently and say, 'Your time will come, my friend.' One day, a woman came into the shop, her eyes red with tears. She had lost a precious locket her grandmother had given her, a locket she remembered holding just that morning. She was distraught, trying to retrace her steps, but her memory was a jumble of stress. Mr. Gable had a thought. He brought Horatio to the woman and set him on the counter. 'Watch this,' he said. The little clock's hands began to move backwards, tocking softly. 'Ah,' said the woman, her eyes following the hands. 'An hour ago... I was paying for my newspaper.' The hands moved further. 'Three hours ago... I was at the cafe.' As the clock's hands swept backwards, so did her memory, becoming clearer and more organized with each tock. 'Wait!' she gasped. 'I remember now! I took it off to wash my hands at the cafe!' She rushed out of the shop, only to return an hour later, the silver locket gleaming in her hand. She bought Horatio on the spot. He didn't just tell time; he found lost time."
                },
                question: "What special ability did Horatio have that helped the woman?",
                choices: [
                    "His backwards movement helped organize her memories",
                    "He could speak to customers",
                    "He glowed to show important moments",
                    "He could stop time completely"
                ],
                correctAnswer: 0,
                difficulty: "hard",
                audioFile: "story_clock_backwards.mp3"
            },
            {
                id: "story10",
                title: "The Mote of Dust That Saw Everything",
                fullText: "A single mote of dust, so small it had no name, drifted on a sunbeam in the grand library. It had no ambitions, no desires, no purpose but to float where the air took it. But from its unique vantage point, it saw everything. It danced over the pages as a young student discovered the secrets of the universe in a physics textbook. It settled gently on the tear that fell from a reader's eye as she finished a tragic love story. It swirled in the triumphant gust of air as a historian slammed a book shut, having finally found the one fact he'd been searching for for years. The mote of dust was there when a child first learned to read, his small finger tracing the letters while his mother whispered the sounds. It was there when an old man revisited a favorite book from his youth, a faint smile on his lips as he remembered a different time. The mote of dust saw stories of adventure, of heartbreak, of discovery, and of quiet comfort. It never made a sound. It never changed a single word. But it was a part of every story, a silent, floating witness to the magic held within the room. It learned that you don't have to be the story to be part of the story. Sometimes, the most important role is simply to be there, to drift, and to see.",
                captions: {
                    25: "dust... library... sunbeam... student... stories... witness... see...",
                    50: "mote dust library sunbeam student stories witness tears discovery child reading silence part story",
                    75: "A mote of dust drifted in the library on a [BLANK]. It witnessed students, readers, and children discovering [BLANK]. It learned you don't have to be the story to be [BLANK] of it.",
                    100: "A single mote of dust, so small it had no name, drifted on a sunbeam in the grand library. It had no ambitions, no desires, no purpose but to float where the air took it. But from its unique vantage point, it saw everything. It danced over the pages as a young student discovered the secrets of the universe in a physics textbook. It settled gently on the tear that fell from a reader's eye as she finished a tragic love story. It swirled in the triumphant gust of air as a historian slammed a book shut, having finally found the one fact he'd been searching for for years. The mote of dust was there when a child first learned to read, his small finger tracing the letters while his mother whispered the sounds. It was there when an old man revisited a favorite book from his youth, a faint smile on his lips as he remembered a different time. The mote of dust saw stories of adventure, of heartbreak, of discovery, and of quiet comfort. It never made a sound. It never changed a single word. But it was a part of every story, a silent, floating witness to the magic held within the room. It learned that you don't have to be the story to be part of the story. Sometimes, the most important role is simply to be there, to drift, and to see."
                },
                question: "What important lesson did the mote of dust learn?",
                choices: [
                    "You don't have to be the story to be part of the story",
                    "Small things can make big changes",
                    "Libraries are magical places",
                    "Reading is the most important skill"
                ],
                correctAnswer: 0,
                difficulty: "hard",
                audioFile: "story_dust_everything.mp3"
            }
        ];
        let currentActivityType = '';
        let currentLevelData = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let currentAudio = null;
        let selectedVoice = 'female';
        let correctWordForTrial = '';
        
        // Story-specific variables
        let currentStory = null;
        let selectedCaptionLevel = 25; // Default to 25% captions
        let currentQuestion = null;
        
        let adminQCMode = localStorage.getItem('adminQCMode') === 'true';
        let qualityIssues = JSON.parse(localStorage.getItem('qualityIssues') || '[]');
        
        let audioCache = new Map();
        let userProgress = {
            currentActivity: null,
            currentLevel: null,
            currentQuestion: 0,
            scores: {},
            completedLevels: new Set()
        };

        function getAudioUrl(filename) {
            return `https://cdn.jsdelivr.net/gh/${GITHUB_USERNAME}/${GITHUB_REPO_NAME}@main/${filename}`;
        }

        function stopCurrentAudio() {
            // Utility function to stop any currently playing audio
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
            }
        }

        function randomizeStoryChoices(story) {
            // Create a copy of the story to avoid modifying the original
            const randomizedStory = { ...story };
            
            // Get the correct answer text before shuffling
            const correctAnswerText = story.choices[story.correctAnswer];
            
            // Create array of choice objects with original indices
            const choicesWithIndices = story.choices.map((choice, index) => ({
                text: choice,
                originalIndex: index
            }));
            
            // Shuffle the choices
            for (let i = choicesWithIndices.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [choicesWithIndices[i], choicesWithIndices[j]] = [choicesWithIndices[j], choicesWithIndices[i]];
            }
            
            // Update the story with shuffled choices and new correct answer index
            randomizedStory.choices = choicesWithIndices.map(item => item.text);
            randomizedStory.correctAnswer = choicesWithIndices.findIndex(item => item.text === correctAnswerText);
            
            return randomizedStory;
        }

        function submitToGoogleForms(qualityIssue) {
            const baseUrl = "https://docs.google.com/forms/d/e/1FAIpQLSdrZdSdORcvQkZm9A_ZWB3J4Q_XOY9HKKpD8GDQiyLEINqu2A/viewform";
            const params = new URLSearchParams({
                'usp': 'pp_url',
                'entry.2092258809': qualityIssue.audioFile,
                'entry.2027416117': qualityIssue.text,
                'entry.2104356900': qualityIssue.voice,
                'entry.1322911479': qualityIssue.activityType,
                'entry.2105236424': qualityIssue.set,
                'entry.64346061': qualityIssue.issueType,
                'entry.1007752238': qualityIssue.severity,
                'entry.215629918': qualityIssue.dateFlagged
            });
            const formUrl = baseUrl + '?' + params.toString();
            window.open(formUrl, '_blank');
            return true;
        }

        function toggleAdminQCMode() {
            adminQCMode = !adminQCMode;
            localStorage.setItem('adminQCMode', adminQCMode.toString());
            
            const qcIndicator = document.getElementById('qc-mode-indicator');
            const qcControls = document.getElementById('qc-controls');
            
            if (adminQCMode) {
                qcIndicator?.classList.remove('hidden');
                qcControls?.classList.remove('hidden');
                console.log('QC Mode ENABLED');
            } else {
                qcIndicator?.classList.add('hidden');
                qcControls?.classList.add('hidden');
                console.log('QC Mode DISABLED');
            }
        }

        function flagAudioQuality() {
            if (!currentLevelData[currentQuestionIndex]) return;
            
            const currentQuestion = currentLevelData[currentQuestionIndex];
            const issueType = document.getElementById('issue-type')?.value || 'unclear_pronunciation';
            
            // Capture actual audio filename and text content
            
            const qualityIssue = {
                audioFile: currentQuestion.audioFilename || currentQuestion.AudioFilename || currentQuestion.audioFile || `${selectedVoice}_${currentActivityType}_${slugify(correctWordForTrial || 'unknown')}.mp3`,
                text: currentQuestion.Word1 || currentQuestion.Word2 || currentQuestion.Sentence1 || currentQuestion.Sentence2 || currentQuestion.Sentence || currentQuestion.text || correctWordForTrial || 'N/A',
                voice: selectedVoice,
                activityType: currentActivityType,
                set: currentQuestion.Set || currentQuestion.set || 'Unknown Set',
                issueType: issueType,
                severity: 'Medium',
                dateFlagged: new Date().toISOString(),
                sentToSheets: false,
                sentToForms: false
            };
            
            qualityIssues.push(qualityIssue);
            localStorage.setItem('qualityIssues', JSON.stringify(qualityIssues));
            console.log('Audio flagged:', qualityIssue);
            
            const flagBtn = document.getElementById('flag-audio-btn');
            const originalText = flagBtn.textContent;
            flagBtn.textContent = 'Flagged!';
            flagBtn.classList.add('bg-green-600');
            flagBtn.classList.remove('bg-red-600');
            
            setTimeout(() => {
                flagBtn.textContent = originalText;
                flagBtn.classList.remove('bg-green-600');
                flagBtn.classList.add('bg-red-600');
            }, 1500);
        }
        
        async function exportQualityData() {
            console.log('=== EXPORT START ===');
            const unsentIssues = qualityIssues.filter(issue => !issue.sentToSheets);
            console.log('Unsent issues:', unsentIssues.length);
            
            if (unsentIssues.length === 0) {
                const retryAll = confirm('No new issues to submit. Reset all and retry?');
                if (retryAll) {
                    qualityIssues.forEach(issue => delete issue.sentToSheets);
                    localStorage.setItem('qualityIssues', JSON.stringify(qualityIssues));
                    return exportQualityData();
                }
                return;
            }
            
            const message = 'Export ' + unsentIssues.length + ' flagged audio issues directly to Google Sheets?';
            const confirmExport = confirm(message);
            
            if (confirmExport) {
                try {
                    await submitToGoogleSheets(unsentIssues);
                    unsentIssues.forEach(issue => issue.sentToSheets = true);
                    localStorage.setItem('qualityIssues', JSON.stringify(qualityIssues));
                    alert('âœ… Successfully exported ' + unsentIssues.length + ' issues to Google Sheets!');
                } catch (error) {
                    console.error('Export failed:', error);
                    const options = 'Direct export failed. Choose fallback option:\n\n' + 
                                  'OK = Google Forms (opens tabs)\n' + 
                                  'Cancel = Download CSV file';
                    const useForms = confirm(options);
                    if (useForms) {
                        await exportToForms(unsentIssues);
                    } else {
                        downloadQCDataAsCSV(unsentIssues);
                    }
                }
            }
            console.log('=== EXPORT COMPLETE ===');
        }

        async function submitToGoogleSheets(issues) {
            console.log('Attempting Google Apps Script submission...');
            
            try {
                await submitViaGoogleAppsScript(issues);
                console.log('Apps Script submission succeeded!');
            } catch (error) {
                console.error('Apps Script submission failed:', error.message);
                throw error;
            }
        }

        function convertIssuesToCSV(issues) {
            const headers = ['Audio File', 'Text', 'Voice', 'Activity Type', 'Set', 'Issue Type', 'Severity', 'Date Flagged', 'Status'];
            const rows = [headers];
            
            issues.forEach(issue => {
                rows.push([
                    issue.audioFile || 'N/A',
                    issue.text || 'N/A', 
                    issue.voice || 'female',
                    issue.activityType || 'N/A',
                    issue.set || 'N/A',
                    issue.issueType || 'unclear_pronunciation',
                    issue.severity || 'Medium',
                    issue.dateFlagged || new Date().toISOString(),
                    'New'
                ]);
            });
            
            return rows.map(row => row.map(cell => '"' + String(cell).replace(/"/g, '""') + '"').join(',')).join('\n');
        }

        function downloadQCDataAsCSV(issues) {
            const csvContent = convertIssuesToCSV(issues);
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'qc-issues-' + new Date().toISOString().split('T')[0] + '.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Mark as exported
                issues.forEach(issue => issue.sentToSheets = true);
                localStorage.setItem('qualityIssues', JSON.stringify(qualityIssues));
                alert('Downloaded ' + issues.length + ' QC issues as CSV file!');
            }
        }

        async function submitViaDirectPost(sheetId, sheetName, csvData) {
            // Method 3: Try direct POST to sheet
            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/edit#gid=0`;
            throw new Error('Direct POST method not yet implemented');
        }

        async function submitViaFormEndpoint(csvData) {
            // Method 2: Try a webhook service
            throw new Error('Form endpoint method not yet implemented'); 
        }

        async function submitViaGoogleAppsScript(issues) {
            // Use GET request with URL parameters to bypass CORS
            const appsScriptUrl = 'https://script.google.com/macros/s/AKfycbynjk1Lu8Gq_z60ZbcOnJpfLYAFSE7rV4S2OCxJvX35AFNe-iyRUaE5-6QfI2Gi-VS1/exec';
            
            console.log('Submitting to Apps Script via GET:', issues);
            
            // Convert issues to URL parameters (simplified for CORS bypass)
            const params = new URLSearchParams({
                action: 'addQCIssues',
                data: JSON.stringify(issues)
            });
            
            const fullUrl = `${appsScriptUrl}?${params.toString()}`;
            
            // Use a simple fetch GET request
            const response = await fetch(fullUrl, {
                method: 'GET',
                mode: 'no-cors' // This bypasses CORS but we won't get response data
            });
            
            // Since we're using no-cors, we can't read the response
            // So we'll assume success and let the user check the sheet
            console.log('Submitted to Apps Script (no-cors mode)');
            
            // Return a mock success response
            return { success: true, message: 'Submitted via GET request' };
        }
        
        async function createQCSheet(sheetId, apiKey) {
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}:batchUpdate?key=${apiKey}`;
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    requests: [{
                        addSheet: {
                            properties: {
                                title: 'QC_Issues',
                                gridProperties: {
                                    rowCount: 1000,
                                    columnCount: 10
                                }
                            }
                        }
                    }]
                })
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Sheet creation failed: ${response.status} - ${errorText}`);
            }
            
            console.log('QC_Issues sheet created successfully');
        }

        async function exportToForms(unsentIssues) {
            // Fallback to original Google Forms method
            console.log('Falling back to Google Forms...');
            for (let i = 0; i < unsentIssues.length; i++) {
                const issue = unsentIssues[i];
                submitToGoogleForms(issue);
                issue.sentToForms = true;
                if (i < unsentIssues.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            localStorage.setItem('qualityIssues', JSON.stringify(qualityIssues));
            alert('Opened ' + unsentIssues.length + ' Google Forms! Please submit each form tab.');
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function slugify(text) {
            if (!text) return '';
            return text.toString().toLowerCase().replaceAll('...', '').replace(/\s+/g, '-').replace(/[^\w\-]+/g, '').replace(/\-\-+/g, '-').replace(/^-+/, '').replace(/-+$/, '');
        }

        async function loadCSVData(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to fetch: ' + response.status);
                
                const csvText = await response.text();
                const lines = csvText.split('\n');
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                
                return lines.slice(1)
                    .filter(line => line.trim())
                    .map(line => {
                        const values = line.split(',').map(v => v.trim().replace(/"/g, ''));
                        const obj = {};
                        headers.forEach((header, index) => {
                            obj[header] = values[index] || '';
                        });
                        return obj;
                    });
            } catch (error) {
                console.error('CSV loading error:', error);
                throw error;
            }
        }

        async function loadAllData() {
            try {
                document.getElementById('loading-status').textContent = 'Loading exercise data...';
                
                const [wordsData, sentencesData, keywordsData] = await Promise.all([
                    loadCSVData('https://docs.google.com/spreadsheets/d/1CNDRfgqSdMEyc0JgW6DerCRX1jUftWSX49nsiBPUbek/gviz/tq?tqx=out:csv&sheet=Words'),
                    loadCSVData('https://docs.google.com/spreadsheets/d/1CNDRfgqSdMEyc0JgW6DerCRX1jUftWSX49nsiBPUbek/gviz/tq?tqx=out:csv&sheet=Sentences'),
                    loadCSVData('https://docs.google.com/spreadsheets/d/1CNDRfgqSdMEyc0JgW6DerCRX1jUftWSX49nsiBPUbek/gviz/tq?tqx=out:csv&sheet=Keywords')
                ]);
                
                allData = { words: wordsData, sentences: sentencesData, keywords: keywordsData, stories: sampleStories };
                
                document.getElementById('loading-progress-bar').style.width = '100%';
                document.getElementById('loading-status').textContent = 'Ready!';
                
                setTimeout(() => {
                    document.getElementById('loading-state').classList.add('hidden');
                    document.getElementById('activity-selection-screen').classList.remove('hidden');
                    
                    // Initialize caption buttons
                    setupCaptionButtons();
                    
                    if (adminQCMode) {
                        toggleAdminQCMode();
                    }
                }, 500);
                
            } catch (error) {
                document.getElementById('loading-status').textContent = 'Failed to load data. Please refresh.';
                console.error('Data loading failed:', error);
            }
        }

        function showActivitySelection() {
            stopCurrentAudio();
            
            document.getElementById('loading-state').classList.add('hidden');
            document.getElementById('level-selection-screen').classList.add('hidden');
            document.getElementById('app-content').classList.add('hidden');
            document.getElementById('activity-selection-screen').classList.remove('hidden');
        }

        function showLevelSelection(activityType) {
            stopCurrentAudio();
            
            currentActivityType = activityType;
            document.getElementById('activity-selection-screen').classList.add('hidden');
            document.getElementById('level-selection-screen').classList.remove('hidden');
            
            const levelButtonsContainer = document.getElementById('level-buttons-container');
            levelButtonsContainer.innerHTML = '';
            
            if (activityType === 'stories') {
                // Handle stories differently - show story titles directly
                sampleStories.forEach((story, index) => {
                    const button = document.createElement('button');
                    button.className = 'w-full py-4 px-5 text-xl font-semibold rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition';
                    button.textContent = story.title;
                    button.onclick = () => startStory(story);
                    levelButtonsContainer.appendChild(button);
                });
            } else {
                const dataForActivity = allData[activityType];
                const sets = [...new Set(dataForActivity.map(item => item.Set))];
                
                sets.forEach(setName => {
                    const button = document.createElement('button');
                    button.className = 'w-full py-4 px-5 text-xl font-semibold rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition';
                    button.textContent = friendlySetNames[setName] || setName;
                    button.onclick = () => startLevel(setName);
                    levelButtonsContainer.appendChild(button);
                });
            }
        }
        
        function startLevel(setName) {
            currentLevelData = allData[currentActivityType].filter(item => item.Set === setName);
            shuffleArray(currentLevelData);
            currentQuestionIndex = 0;
            score = 0;
            
            document.getElementById('exercise-title').textContent = friendlySetNames[setName] || setName;
            document.getElementById('level-selection-screen').classList.add('hidden');
            document.getElementById('completion-screen').classList.add('hidden');
            document.querySelector('main').classList.remove('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            
            loadQuestion();
        }

        function startStory(story) {
            // Randomize the story choices before setting currentStory
            currentStory = randomizeStoryChoices(story);
            currentQuestionIndex = 0;
            score = 0;
            
            document.getElementById('exercise-title').textContent = currentStory.title;
            document.getElementById('level-selection-screen').classList.add('hidden');
            document.getElementById('completion-screen').classList.add('hidden');
            document.querySelector('main').classList.remove('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            
            loadStoryQuestion();
        }

        function loadStoryQuestion() {
            // Show story interface, hide regular question interface
            document.getElementById('choice-container').classList.add('hidden');
            document.getElementById('keyword-question-container').classList.add('hidden');
            document.getElementById('story-interface').classList.remove('hidden');
            
            // Reset UI state
            document.getElementById('feedback-message').className = 'mt-6 text-xl font-semibold h-8';
            document.getElementById('play-sound-btn').disabled = false;
            
            // Update story caption based on selected level
            updateStoryCaption();
            
            // Setup story question
            document.getElementById('story-question-text').textContent = currentStory.question;
            
            // Setup story choices
            const choicesContainer = document.getElementById('story-choices');
            choicesContainer.innerHTML = '';
            
            currentStory.choices.forEach((choice, index) => {
                const button = document.createElement('button');
                button.className = 'w-full py-3 px-4 text-left font-semibold rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition disabled:bg-gray-200 disabled:cursor-not-allowed';
                button.textContent = choice;
                button.disabled = true;
                button.onclick = () => handleStoryAnswer(index);
                button.id = `story-choice-${index}`;
                choicesContainer.appendChild(button);
            });
            
            // Setup audio
            const audioFolder = `${selectedVoice}_audio`;
            const audioUrl = getAudioUrl(`${audioFolder}/${currentStory.audioFile}`);
            
            currentAudio = new Audio(audioUrl);
            currentAudio.onerror = (e) => {
                console.error("Story audio loading error:", audioUrl, e);
                document.getElementById('feedback-message').textContent = `Error loading story audio.`;
                document.getElementById('play-sound-btn').disabled = true;
            };
            
            // Update progress
            document.getElementById('current-question').textContent = '1';
            document.getElementById('total-questions').textContent = '1';
            document.getElementById('progress-bar').style.width = '0%';
        }

        function loadQuestion() {
            if (currentQuestionIndex >= currentLevelData.length) {
                showCompletionScreen();
                return;
            }
            
            // Show regular interface, hide story interface
            document.getElementById('choice-container').classList.remove('hidden');
            document.getElementById('story-interface').classList.add('hidden');
            
            // Reset UI state
            document.getElementById('feedback-message').className = 'mt-6 text-xl font-semibold h-8';
            document.getElementById('choice1-btn').className = 'w-full py-3 px-4 text-lg font-semibold rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition disabled:bg-gray-200 disabled:cursor-not-allowed';
            document.getElementById('choice2-btn').className = 'w-full py-3 px-4 text-lg font-semibold rounded-lg border-2 border-gray-300 hover:bg-gray-100 transition disabled:bg-gray-200 disabled:cursor-not-allowed';
            document.getElementById('choice1-btn').disabled = true;
            document.getElementById('choice2-btn').disabled = true;
            document.getElementById('play-sound-btn').disabled = false;
            document.getElementById('keyword-question-container').classList.add('hidden');

            const currentItem = currentLevelData[currentQuestionIndex];
            let audioText = '';
            
            if (currentActivityType === 'words' || currentActivityType === 'sentences') {
                const options = [currentItem.Word1 || currentItem.Sentence1, currentItem.Word2 || currentItem.Sentence2];
                shuffleArray(options);
                document.getElementById('choice1-btn').textContent = (options[0] || '').replaceAll('...', '');
                document.getElementById('choice2-btn').textContent = (options[1] || '').replaceAll('...', '');
                audioText = Math.random() > 0.5 ? options[0] : options[1];
            } else if (currentActivityType === 'keywords') {
                document.getElementById('keyword-question-container').textContent = currentItem.Question;
                document.getElementById('keyword-question-container').classList.remove('hidden');
                const options = [currentItem.Keyword1, currentItem.Keyword2];
                shuffleArray(options);
                document.getElementById('choice1-btn').textContent = (options[0] || '').replaceAll('...', '');
                document.getElementById('choice2-btn').textContent = (options[1] || '').replaceAll('...', '');
                audioText = currentItem.Sentence;
            }
            
            correctWordForTrial = audioText;
            
            const audioFolder = `${selectedVoice}_audio`;
            const audioFileName = slugify(audioText) + '.mp3';
            const audioUrl = `https://cdn.jsdelivr.net/gh/${GITHUB_USERNAME}/${GITHUB_REPO_NAME}@main/${audioFolder}/${audioFileName}`;
            
            currentAudio = new Audio(audioUrl);
            currentAudio.onerror = (e) => {
                console.error("Audio loading error:", audioUrl, e);
                document.getElementById('feedback-message').textContent = `Error loading audio.`;
                document.getElementById('play-sound-btn').disabled = true;
            };

            document.getElementById('total-questions').textContent = currentLevelData.length;
            document.getElementById('current-question').textContent = currentQuestionIndex + 1;
            document.getElementById('current-score').textContent = score;
            document.getElementById('progress-bar').style.width = `${((currentQuestionIndex + 1) / currentLevelData.length) * 100}%`;
        }

        function handleAnswer(selectedButton) {
            document.getElementById('play-sound-btn').disabled = true;
            document.getElementById('choice1-btn').disabled = true;
            document.getElementById('choice2-btn').disabled = true;
            
            let isCorrect = false;
            const selectedText = selectedButton.textContent;
            
            if (currentActivityType === 'keywords') {
                const correctKeywordClean = currentLevelData[currentQuestionIndex].Keyword1.replaceAll('...', '');
                isCorrect = selectedText === correctKeywordClean;
            } else {
                isCorrect = selectedText === correctWordForTrial.replaceAll('...', '');
            }

            if (isCorrect) {
                score++;
                const correctMessages = [
                    'Excellent!', 'Perfect!', 'Great job!', 'Well done!', 'Nice work!', 
                    'Outstanding!', 'Fantastic!', 'You got it!', 'Brilliant!', 'Superb!'
                ];
                const randomCorrect = correctMessages[Math.floor(Math.random() * correctMessages.length)];
                document.getElementById('feedback-message').textContent = randomCorrect;
                document.getElementById('feedback-message').classList.add('text-green-500');
                selectedButton.classList.add('correct-answer');
            } else {
                const encouragingMessages = [
                    'Keep practicing!', 'Almost there!', 'Good effort!', 'You\'re learning!', 
                    'Nice try!', 'Getting closer!', 'Keep going!', 'Stay focused!', 
                    'You\'re improving!', 'Practice makes progress!', 'Keep listening!', 
                    'You\'ve got this!', 'Learning in progress!'
                ];
                const randomEncouraging = encouragingMessages[Math.floor(Math.random() * encouragingMessages.length)];
                document.getElementById('feedback-message').textContent = randomEncouraging;
                document.getElementById('feedback-message').classList.add('text-orange-500');
                selectedButton.classList.add('wrong-answer');
            }

            setTimeout(() => {
                currentQuestionIndex++;
                loadQuestion();
            }, 1500);
        }

        function showCompletionScreen() {
            document.querySelector('main').classList.add('hidden');
            document.getElementById('completion-screen').classList.remove('hidden');
            document.getElementById('final-score').textContent = score;
            
            // For stories, there's only 1 question. For other activities, use currentLevelData.length
            const totalQuestions = currentActivityType === 'stories' ? 1 : currentLevelData.length;
            document.getElementById('total-score').textContent = totalQuestions;
            document.getElementById('final-progress-bar').style.width = `${(score / totalQuestions) * 100}%`;
        }

        // Story-specific functions
        function updateStoryCaption() {
            const captionElement = document.getElementById('story-caption');
            captionElement.textContent = currentStory.captions[selectedCaptionLevel];
        }

        function handleStoryAnswer(selectedIndex) {
            // Stop any currently playing audio immediately
            stopCurrentAudio();
            
            // Disable all story choice buttons
            currentStory.choices.forEach((_, index) => {
                document.getElementById(`story-choice-${index}`).disabled = true;
            });
            
            const selectedButton = document.getElementById(`story-choice-${selectedIndex}`);
            const isCorrect = selectedIndex === currentStory.correctAnswer;
            
            if (isCorrect) {
                score++;
                const correctMessages = [
                    'Excellent!', 'Perfect!', 'Great job!', 'Well done!', 'Nice work!', 
                    'Outstanding!', 'Fantastic!', 'You got it!', 'Brilliant!', 'Superb!'
                ];
                const randomCorrect = correctMessages[Math.floor(Math.random() * correctMessages.length)];
                document.getElementById('feedback-message').textContent = randomCorrect;
                document.getElementById('feedback-message').classList.add('text-green-500');
                selectedButton.classList.add('correct-answer');
            } else {
                const encouragingMessages = [
                    'Keep practicing!', 'Almost there!', 'Good effort!', 'You\'re learning!', 
                    'Nice try!', 'Getting closer!', 'Keep going!', 'Stay focused!', 
                    'You\'re improving!', 'Practice makes progress!', 'Keep listening!', 
                    'You\'ve got this!', 'Learning in progress!'
                ];
                const randomEncouraging = encouragingMessages[Math.floor(Math.random() * encouragingMessages.length)];
                document.getElementById('feedback-message').textContent = randomEncouraging;
                document.getElementById('feedback-message').classList.add('text-orange-500');
                selectedButton.classList.add('wrong-answer');
            }
            
            // Show correct answer
            document.getElementById(`story-choice-${currentStory.correctAnswer}`).classList.add('correct-answer');
            
            // Progress to completion after delay
            setTimeout(() => {
                showCompletionScreen();
            }, 2000);
        }

        // Caption level button handlers
        function setupCaptionButtons() {
            document.querySelectorAll('.caption-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    // Update selected caption level
                    selectedCaptionLevel = parseInt(btn.dataset.captionLevel);
                    
                    // Update button styles
                    document.querySelectorAll('.caption-btn').forEach(b => {
                        b.className = 'caption-btn px-3 py-1 text-xs rounded-full border border-gray-300';
                    });
                    btn.className = 'caption-btn px-3 py-1 text-xs rounded-full border bg-blue-600 text-white';
                    
                    // Update caption display
                    if (currentStory) {
                        updateStoryCaption();
                    }
                });
            });
        }


        // Event Listeners
        document.getElementById('flag-audio-btn')?.addEventListener('click', flagAudioQuality);
        document.getElementById('disable-qc-btn')?.addEventListener('click', toggleAdminQCMode);
        document.getElementById('export-qc-btn')?.addEventListener('click', exportQualityData);
        
        document.querySelectorAll('.activity-btn').forEach(btn => {
            btn.addEventListener('click', () => showLevelSelection(btn.dataset.activity));
        });

        document.getElementById('voice-toggle').addEventListener('click', () => {
            selectedVoice = selectedVoice === 'female' ? 'male' : 'female';
            document.getElementById('voice-toggle').classList.toggle('female');
            document.getElementById('voice-toggle').classList.toggle('male');
        });

        document.getElementById('back-to-activities').addEventListener('click', showActivitySelection);
        document.getElementById('back-to-levels').addEventListener('click', () => showLevelSelection(currentActivityType));
        document.getElementById('next-level-btn').addEventListener('click', () => showLevelSelection(currentActivityType));
        document.getElementById('retry-level-btn').addEventListener('click', () => startLevel(document.getElementById('exercise-title').textContent));

        document.getElementById('play-sound-btn').addEventListener('click', () => {
            if (currentAudio) {
                currentAudio.play().catch(e => console.error("Error playing audio:", e));
                
                // Enable appropriate choice buttons based on activity type
                if (currentActivityType === 'stories') {
                    currentStory.choices.forEach((_, index) => {
                        document.getElementById(`story-choice-${index}`).disabled = false;
                    });
                } else {
                    document.getElementById('choice1-btn').disabled = false;
                    document.getElementById('choice2-btn').disabled = false;
                }
            }
        });

        document.getElementById('choice1-btn').addEventListener('click', () => handleAnswer(document.getElementById('choice1-btn')));
        document.getElementById('choice2-btn').addEventListener('click', () => handleAnswer(document.getElementById('choice2-btn')));

        // Triple-tap to enable QC mode
        let titleTapCount = 0;
        let titleTapTimer = null;
        document.getElementById('category-title').addEventListener('click', () => {
            titleTapCount++;
            if (titleTapTimer) clearTimeout(titleTapTimer);
            
            if (titleTapCount === 3) {
                toggleAdminQCMode();
                titleTapCount = 0;
            } else {
                titleTapTimer = setTimeout(() => {
                    titleTapCount = 0;
                }, 1000);
            }
        });

        // Initialize
        loadAllData();
    </script>
</body>
</html>